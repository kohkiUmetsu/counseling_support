# フェーズ2: 音声処理・文字起こしシステムチケット

## 概要
音声ファイルのアップロード、録音、文字起こし機能を実装するフェーズです。要件定義書の機能F001、F002、F003に対応します。

---

## チケット F2-001: 音声録音機能実装（F001）
**優先度**: 高  
**見積**: 8時間  
**担当者**: フロントエンドエンジニア

### 説明
ブラウザ上でMediaRecorder APIを使用した音声録音機能を実装する。

### 要件
- MediaRecorder APIを使用したリアルタイム録音
- 録音中の波形表示
- 録音停止・再生機能
- 対応フォーマット: WebM, MP3, WAV, M4A

### 受け入れ条件
- [ ] ブラウザで音声録音が開始・停止できる
- [ ] 録音中にリアルタイム波形が表示される
- [ ] 録音した音声をその場で再生できる
- [ ] 録音データを適切なフォーマットで保存できる
- [ ] マイクアクセス許可の適切なハンドリング

### 技術詳細
```typescript
// 実装対象コンポーネント
- AudioRecorder: 録音制御メインコンポーネント
- WaveformVisualizer: リアルタイム波形表示
- AudioPlayer: 録音済み音声再生
- RecordingControls: 録音開始/停止/一時停止ボタン

// 使用技術
- MediaRecorder API
- Web Audio API (波形表示)
- React hooks (useMediaRecorder)
```

---

## チケット F2-002: 音声ファイルアップロード機能（F001）
**優先度**: 高  
**見積**: 6時間  
**担当者**: フルスタックエンジニア

### 説明
音声ファイルのアップロード機能とバックエンドでの受信処理を実装する。

### 要件
- 最大ファイルサイズ: 500MB
- 対応フォーマット: WebM, MP3, WAV, M4A
- プログレスバー表示
- S3への自動アップロード

### 受け入れ条件
- [ ] ドラッグ&ドロップで音声ファイルをアップロードできる
- [ ] アップロード進捗がプログレスバーで表示される
- [ ] 500MB以下のファイルサイズ制限が機能する
- [ ] 対応フォーマット以外はエラー表示される
- [ ] アップロード後にS3に音声ファイルが保存される
- [ ] アップロード完了後にセッションIDが返される

### 技術詳細
```python
# バックエンドAPI
POST /api/v1/sessions/upload
- multipart/form-data受信
- ファイル形式・サイズバリデーション
- S3アップロード処理
- セッション情報DB保存

# フロントエンド
- react-dropzone使用
- axios（アップロード進捗対応）
- TypeScriptでの型安全なファイル処理
```

---

## チケット F2-003: 成功/失敗ラベル登録機能（F001）
**優先度**: 高  
**見積**: 4時間  
**担当者**: フロントエンドエンジニア

### 説明
アップロードした音声に成功/失敗のラベルを付与する機能を実装する。

### 要件
- 音声アップロード後にラベル選択UI表示
- 成功/失敗の二択選択
- 担当者情報、コメント入力
- ラベル情報のDB保存

### 受け入れ条件
- [ ] アップロード後にラベル選択画面が表示される
- [ ] 成功/失敗を選択できる
- [ ] 担当者名を入力できる
- [ ] オプションでコメントを追加できる
- [ ] ラベル情報がcounseling_sessionsテーブルに保存される

### 技術詳細
```typescript
// コンポーネント
- LabelingForm: ラベル付けフォーム
- SuccessFailureToggle: 成功/失敗切り替え
- MetadataForm: 担当者情報・コメント入力

// API
PATCH /api/v1/sessions/{id}/label
```

---

## チケット F2-004: OpenAI Whisper文字起こし実装（F002）
**優先度**: 高  
**見積**: 10時間  
**担当者**: バックエンドエンジニア

### 説明
OpenAI Whisper APIを使用した音声文字起こし機能を実装する。

### 要件
- OpenAI Whisper APIとの連携
- 話者分離対応
- タイムスタンプ付き文字起こし
- 日本語対応
- 非同期処理（長時間音声対応）

### 受け入れ条件
- [ ] OpenAI Whisper APIで音声が文字起こしされる
- [ ] 話者分離（カウンセラー/顧客）が機能する
- [ ] タイムスタンプ付きで文字起こし結果が保存される
- [ ] 30分の音声を5分以内で処理できる
- [ ] 処理状況をリアルタイムで確認できる

### 技術詳細
```python
# 実装対象サービス
- TranscriptionService: Whisper API呼び出し
- SpeakerDiarizationService: 話者分離
- TimestampService: タイムスタンプ処理

# 処理フロー
1. S3から音声ファイル取得
2. Whisper APIで文字起こし
3. 話者分離処理
4. タイムスタンプ付きでDB保存
5. 処理状況更新

# 非同期処理
- Celery + Redis使用
- 処理状況をWebSocketで通知
```

---

## チケット F2-005: 文字起こしデータ管理・表示（F003）
**優先度**: 中  
**見積**: 6時間  
**担当者**: フルスタックエンジニア

### 説明
文字起こしデータの保存・管理・表示機能を実装する。

### 要件
- RDSに文字起こしテキスト保存
- 話者別色分け表示
- タイムスタンプクリックで音声再生
- 文字起こし結果の編集機能

### 受け入れ条件
- [ ] transcriptionsテーブルに適切に保存される
- [ ] 話者ごとに色分けして表示される
- [ ] タイムスタンプをクリックすると該当箇所から音声再生される
- [ ] 文字起こし結果を手動で編集できる
- [ ] 編集内容が保存される

### 技術詳細
```typescript
// フロントエンドコンポーネント
- TranscriptionViewer: 文字起こし表示メイン
- SpeakerSegment: 話者別セグメント
- TimestampPlayer: タイムスタンプ付き音声プレーヤー
- TranscriptionEditor: 編集機能

// バックエンドAPI
GET /api/v1/sessions/{id}/transcription
PUT /api/v1/transcriptions/{id}
```

---

## チケット F2-006: 処理状況通知・エラーハンドリング
**優先度**: 中  
**見積**: 4時間  
**担当者**: フルスタックエンジニア

### 説明
音声処理の進捗通知とエラーハンドリング機能を実装する。

### 要件
- リアルタイム処理状況通知
- WebSocketまたはServer-Sent Events使用
- エラー時の適切な通知とリトライ機能

### 受け入れ条件
- [ ] アップロード〜文字起こし完了まで進捗が表示される
- [ ] 処理エラー時に適切なエラーメッセージが表示される
- [ ] 失敗時にリトライボタンが表示される
- [ ] 複数ファイルの並行処理状況が確認できる

### 技術詳細
```python
# バックエンド通知
- WebSocket接続管理
- 処理状況の段階的通知
- エラー詳細情報の返却

# フロントエンド
- WebSocket接続・切断処理
- プログレス表示コンポーネント
- エラー状態管理
```

---

## フェーズ2完了条件
- [ ] 全チケットが完了している
- [ ] ブラウザで音声録音・アップロードが正常動作する
- [ ] OpenAI Whisperによる文字起こしが正常動作する
- [ ] 話者分離・タイムスタンプ付き文字起こしが機能する
- [ ] 成功/失敗ラベルの登録が正常動作する
- [ ] 処理状況のリアルタイム通知が機能する