# 美容医療クリニック向けカウンセリングスクリプト改善AIツール 要件定義書

## 1. プロジェクト概要

### 1.1 背景
美容脱毛業界では「安価なプランで集客 → カウンセリングで高額プランを提案する」営業モデルが主流である。しかし、カウンセリング担当者のスキル差により成約率に大きなばらつきがある。

### 1.2 目的
過去の成功/失敗カウンセリング会話をもとに、成約率の高いスクリプトをAIが自動で生成・更新することで、店舗全体のカウンセリング品質と成約率を向上させる。

### 1.3 スコープ
- 個別のカウンセラーへの都度フィードバックは行わない
- 店舗全体で1つの改善スクリプトを管理・更新する

## 2. ステークホルダー

| ロール | 責務 | 期待する価値 |
|--------|------|--------------|
| 店長・教育担当者 | 音声アップロード、成功/失敗ラベル付け、スクリプト管理 | 最新の改善スクリプトを確認・展開できる |
| カウンセラー | 改善スクリプトの確認・実践 | 成約率向上につながる言い回しや流れを学べる |

## 3. 機能要件

### 3.1 録音・アップロード機能
- **機能ID**: F001
- **概要**: カウンセリング音声の録音・アップロードと管理
- **詳細要件**:
  - ブラウザ上でMediaRecorder APIを使用した音声録音
  - 録音済み音声ファイルのアップロード機能
  - 成功/失敗のラベル登録
  - アップロード日時、担当者情報の記録
  - 対応音声フォーマット: WebM, MP3, WAV, M4A
  - 最大ファイルサイズ: 500MB
  - 録音中のリアルタイム波形表示

### 3.2 音声文字起こし機能
- **機能ID**: F002
- **概要**: アップロードされた音声の自動文字起こし
- **詳細要件**:
  - OpenAI Whisperを使用した高精度文字起こし
  - 話者分離（カウンセラー/顧客）対応
  - タイムスタンプ付き文字起こしデータ生成
  - 日本語対応

### 3.3 会話データ管理機能
- **機能ID**: F003
- **概要**: 文字起こしデータと音声ファイルの保存・管理
- **詳細要件**:
  - RDSに文字起こしテキストとメタ情報を保存
  - Amazon S3に音声ファイルを保存

### 3.4 ベクトル化・高精度検索機能（コア機能）
- **機能ID**: F004
- **概要**: 成功会話の意味的検索とスクリプト精度向上
- **詳細要件**:
  - text-embedding-3-smallを使用したテキストベクトル化
  - 成功会話のみをベクトル化してAurora pgvectorに保存
  - 失敗会話はベクトル化せず、比較分析用にRDSに保存
  - **意味的類似検索**: 失敗会話と類似した成功会話をベクトル検索で抽出
  - **代表成功会話抽出**: ベクトルクラスタリングで成功パターンを分類
  - **共通成分分析**: ベクトル空間での高頻出パターン検出

### 3.5 高精度スクリプト改善生成機能（メインコア機能）
- **機能ID**: F005
- **概要**: ベクトルDBを活用した高精度な改善スクリプトのAI生成
- **詳細要件**:
  - **代表成功会話抽出**: ベクトルクラスタリングで成功パターンを分類し、各クラスタから代表例を自動抽出
  - **失敗対応成功会話検索**: 失敗会話と意味的に類似した成功会話をベクトル検索で発見
  - **網羅性確保**: 代表クラスタごとの成功会話をGPT-4oに送信し、網羅的な分析を実現
  - **高品質プロンプト生成**: 意味的に選抜された成功会話でLLMの入力品質を最大化
  - 出力内容：
    - 成功パターン別の共通要因（クラスタリング結果ベース）
    - 失敗→成功への具体的改善ポイント
    - 改善されたスクリプト案（Markdown形式）
    - 実際の成功例から抽出した具体的言い回し例
  - 生成トリガー：手動実行

### 3.6 管理画面・レポート機能
- **機能ID**: F006
- **概要**: スクリプト表示と管理機能
- **詳細要件**:
  - 最新版スクリプトの表示
  - 過去のスクリプト履歴管理
  - Markdown/CSV形式でのダウンロード
  - **スクリプト品質メトリクス表示**: カバレッジ率、新規性、推奨信頼度の表示
  - **成功パターン分析結果**: クラスタリング結果と代表例の可視化
  - 成約率推移グラフ表示
  - スクリプト更新通知機能

### 3.7 ベクトル検索エンジン機能
- **機能ID**: F007
- **概要**: スクリプト精度向上のための高度なベクトル検索機能
- **詳細要件**:
  - **クラスタリング機能**: K-meansまたはHDBSCANで成功会話を意味的にグルーピング
  - **類似度検索**: コサイン類似度で高精度な意味検索を実現
  - **代表例抽出**: 各クラスタの重心に最も近い成功会話を自動選出
  - **異常検出**: 一般的な成功パターンから外れた特殊成功例の識別
  - **動的フィルタリング**: 成約率、時期、スタッフなどの条件でベクトル検索結果を絞り込み

### 3.8 スクリプト品質分析機能
- **機能ID**: F008
- **概要**: 生成されたスクリプトの品質と有効性を定量的に評価
- **詳細要件**:
  - **カバレッジ分析**: 生成スクリプトがどの程度の成功パターンを網羅しているかを数値化
  - **新規性スコア**: 過去のスクリプトとの差分をベクトル空間で計算
  - **成功要素マッチング率**: 今回のスクリプトが何％の成功要素を含んでいるかを分析
  - **推奨信頼度**: ベースとなった成功会話の品質と量に基づく推奨度スコア

## 4. 非機能要件

### 4.1 性能要件
- 音声アップロード: 500MBのファイルを3分以内に処理
- 文字起こし: 30分の音声を5分以内に処理
- **ベクトル検索**: 1000件の成功会話から類似会話を5秒以内で検索
- **クラスタリング**: 500件の成功会話のパターン分類。30秒以内で完了
- 高精度スクリプト生成: 100件の代表成功会話から5分以内に生成
- 同時接続ユーザー数: 50人

### 4.2 セキュリティ要件
- HTTPSによる通信の暗号化
- 音声ファイルの暗号化保存
- 個人情報のマスキング機能

## 5. 分析フロー

### 5.1 システム全体のデータフロー

```
[音声録音/アップロード] 
         ↓
[文字起こし (Whisper API)]
         ↓
[RDSテキスト保存 + S3音声保存]
         ↓
[成功/失敗ラベル判定]
         ↓
    ┌────┴────┐
    │              │
[成功会話]      [失敗会話]
    │              │
[ベクトル化]      [RDS保存のみ]
    │              │
[Aurora pgvector]  [比較分析用]
    │              │
    └────┬────┘
         ↓
[スクリプト改善生成フロー]
```

### 5.2 スクリプト改善生成の詳細フロー

```
■ フェーズ1: 成功会話のクラスタリング
[成功会話ベクトル群] 
         ↓
[K-means/HDBSCAN クラスタリング]
         ↓
[成功パターン別グループ分類]
  │
  ├─ クラスタ1: 共感型アプローチ
  ├─ クラスタ2: ロジカル提案型
  ├─ クラスタ3: 価格誘導型
  └─ クラスタ4: 急かし型

■ フェーズ2: 代表例抽出
[各クラスタ] 
         ↓
[重心距離最小の会話を代表例として抽出]
         ↓
[代表成功会話リスト (5-10件)]

■ フェーズ3: 失敗対応成功例検索
[失敗会話テキスト] 
         ↓
[ベクトル化 (一時的)]
         ↓
[コサイン類似度で成功会話を検索]
         ↓
[「似た状況で成功した例」を抽出]

■ フェーズ4: 高品質プロンプト構築
[代表成功会話] + [失敗対応成功例] + [失敗会話]
         ↓
[GPT-4o プロンプト構築]
  │
  ├─ 成功パターン別分析
  ├─ 失敗→成功の改善ポイント
  └─ 網羅的なスクリプト生成

■ フェーズ5: 品質分析と検証
[生成スクリプト] 
         ↓
[カバレッジ分析] → 何％の成功パターンを網羅？
         ↓
[新規性スコア] → 過去スクリプトとの差分
         ↓
[推奨信頼度] → ベースデータの品質評価
         ↓
[最終スクリプト + 品質メトリクス]
```

### 5.3 ベクトル検索の技術的フロー

```
■ 初期セットアップ
[成功会話テキスト] 
         ↓
[チャンク分割 (512トークン単位)]
         ↓
[OpenAI text-embedding-3-small でベクトル化]
         ↓
[Aurora pgvector に保存 (1536次元ベクトル)]

■ クラスタリング実行
[ベクトル群をメモリにロード] 
         ↓
[K-means (k=5-10) または HDBSCAN でクラスタリング]
         ↓
[クラスタ中心との距離で代表例選出]

■ 類似検索実行
[クエリテキスト (失敗会話)] 
         ↓
[ベクトル化]
         ↓
[pgvector でコサイン類似度検索]
         ↓
[Top-K (5-20件) 類似成功会話を返却]
```

### 5.4 システム性能最適化ポイント

| フェーズ | 最適化ポイント | 期待効果 |
|----------|------------|----------|
| ベクトル化 | バッチ処理で複数テキストを同時処理 | 50%高速化 |
| クラスタリング | scikit-learnの並列処理機能活用 | 30%高速化 |
| 類似検索 | pgvectorのインデックス最適化 | 80%高速化 |
| LLM呼び出し | プロンプトサイズ最適化でコスト削減 | 40%コスト削減 |

## 6. 技術アーキテクチャ

### 6.1 システム構成図
```
┌─────────────────┐
│   Frontend      │
│   (Next.js)     │
│   Container     │
└────────┬────────┘
         │ HTTPS
         │
    ┌────┴────┐
    │   ALB   │
    └────┬────┘
         │
    ┌────┴────────────────────┐
    │    ECS + Fargate       │
    │  ┌─────────────────┐   │
    │  │  FastAPI        │   │
    │  │  Container      │   │
    │  └─────────────────┘   │
    └──────┬──────────┬──────┘
           │          │
    ┌──────┴────┐ ┌──┴───────────┐
    │  OpenAI   │ │ AWS Services │
    │  APIs     │ │ ┌─────────┐ │
    └───────────┘ │ │   RDS   │ │
                  │ ├─────────┤ │
                  │ │ Aurora  │ │
                  │ │pgvector │ │
                  │ ├─────────┤ │
                  │ │   S3    │ │
                  │ └─────────┘ │
                  └─────────────┘
```

### 6.2 技術スタック詳細

| レイヤー | 技術 | 選定理由 |
|----------|------|----------|
| フロントエンド | Next.js 14 + TypeScript | SSR/SSG対応、型安全性、React生態系 |
| スタイリング | Tailwind CSS | 開発速度、カスタマイズ性 |
| 音声録音 | MediaRecorder API | ブラウザネイティブ、追加ライブラリ不要、リアルタイム録音 |
| バックエンド | FastAPI (Python 3.11) | 高速、非同期対応、OpenAPI自動生成 |
| コンテナ | Docker | 環境の一貫性、デプロイの簡素化 |
| オーケストレーション | ECS + Fargate | サーバーレス、自動スケーリング、運用負荷軽減 |
| IaC | Terraform | インフラのコード化、バージョン管理、再現性 |
| 音声処理 | OpenAI Whisper API | 高精度、日本語対応、メンテナンス不要 |
| LLM | OpenAI GPT-4o | 高性能、日本語理解力 |
| Embedding | text-embedding-3-small | コスト効率、精度のバランス |
| ベクトルDB | Aurora PostgreSQL + pgvector | AWSマネージド、スケーラビリティ |
| RAG | LangChain | 豊富な機能、コミュニティサポート |
| RDB | Amazon RDS (PostgreSQL) | 信頼性、バックアップ機能 |
| ストレージ | Amazon S3 | 耐久性、コスト効率 |

### 6.3 ベトル処理アーキテクチャ

```
┌───────────────────────────────┐
│        ベクトル処理レイヤー          │
├───────────────────────────────┤
│ [テキスト前処理] → [ベクトル化] → [クラスタリング] │
│           ↓              ↓              ↓        │
│    [LangChain]    [OpenAI API]   [scikit-learn]   │
└───────────────────────────────┘
           ↓
┌───────────────────────────────┐
│         ベクトルストレージレイヤー         │
├───────────────────────────────┤
│  Aurora pgvector (1536次元ベクトルストレージ)  │
│  ・ IVFFLAT インデックスで高速検索        │
│  ・ コサイン類似度計算に最適化          │
│  ・ 自動バックアップとスケーリング        │
└───────────────────────────────┘
           ↓
┌───────────────────────────────┐
│          AI分析レイヤー             │
├───────────────────────────────┤
│  GPT-4o + 精度最適化プロンプト        │
│  ・ 代表成功会話の自動選抜          │
│  ・ 失敗対応成功例のコンテキスト化     │
│  ・ 網羅的スクリプト生成アルゴリズム   │
└───────────────────────────────┘
```

## 7. データモデル

### 7.1 主要エンティティ

```sql
-- カウンセリングセッション
CREATE TABLE counseling_sessions (
    id UUID PRIMARY KEY,
    uploaded_at TIMESTAMP NOT NULL,
    uploaded_by VARCHAR(255) NOT NULL,
    audio_file_url TEXT NOT NULL,
    duration_seconds INTEGER,
    success_label BOOLEAN NOT NULL,
    clinic_id VARCHAR(255),
    counselor_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 文字起こしデータ
CREATE TABLE transcriptions (
    id UUID PRIMARY KEY,
    session_id UUID REFERENCES counseling_sessions(id),
    full_text TEXT NOT NULL,
    speaker_segments JSONB, -- [{speaker: "counselor", text: "...", timestamp: "00:00:00"}]
    processing_status VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 改善スクリプト
CREATE TABLE improvement_scripts (
    id UUID PRIMARY KEY,
    version INTEGER NOT NULL,
    script_content TEXT NOT NULL,
    success_factors JSONB,
    failure_patterns JSONB,
    generated_at TIMESTAMP NOT NULL,
    generated_by VARCHAR(50), -- "manual" or "auto"
    is_active BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 成功会話ベクトル（Aurora pgvector）
CREATE TABLE success_conversation_vectors (
    id UUID PRIMARY KEY,
    session_id UUID REFERENCES counseling_sessions(id),
    chunk_text TEXT NOT NULL,
    embedding vector(1536),
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 8. API仕様

### 7.1 主要エンドポイント

| メソッド | パス | 説明 |
|----------|------|------|
| POST | /api/v1/sessions/upload | 音声ファイルアップロード |
| GET | /api/v1/sessions | セッション一覧取得 |
| GET | /api/v1/sessions/{id}/transcription | 文字起こし取得 |
| POST | /api/v1/scripts/generate | スクリプト生成実行 |
| GET | /api/v1/scripts/latest | 最新スクリプト取得 |

### 7.2 レスポンス例

```json
// POST /api/v1/sessions/upload レスポンス
{
  "session_id": "123e4567-e89b-12d3-a456-426614174000",
  "status": "processing",
  "estimated_completion_time": "2024-01-20T10:30:00Z",
  "message": "音声ファイルを受信しました。文字起こし処理を開始します。"
}

// GET /api/v1/scripts/latest レスポンス
{
  "script_id": "789e0123-e89b-12d3-a456-426614174000",
  "version": 5,
  "generated_at": "2024-01-20T09:00:00Z",
  "content": {
    "opening": "お客様、本日はご来店ありがとうございます...",
    "needs_assessment": "まず、お客様のお悩みをお聞かせください...",
    "solution_proposal": "お客様のお悩みに最適なプランをご提案させていただきます...",
    "closing": "本日は貴重なお時間をいただきありがとうございました..."
  },
  "success_factors": [
    "顧客の悩みに共感する言葉を使用",
    "具体的な効果や期間を明示",
    "押し売りではなく提案型のアプローチ"
  ],
  "improvement_points": [
    "価格の話は最後に持ってくる",
    "専門用語を避けて分かりやすく説明",
    "顧客の反応を見ながらペース調整"
  ]
}
```

## 9. ディレクトリ構造

```
/your-project-root
├── frontend/                 # Next.js App router (音声録音・UI)
│   ├── public/
│   ├── app/
│   │   ├── pages/           # ページコンポーネント
│   │   ├── components/      # 再利用可能コンポーネント
│   │   ├── lib/            # APIクライアント・hooks
│   │   ├── styles/         # スタイル定義
│   │   └── utils/          # ユーティリティ関数
│   ├── next.config.js
│   ├── Dockerfile
│   └── .env.local
│
├── backend/                 # FastAPI (MVC構成)
│   ├── app/
│   │   ├── api/            # ルーティング (Controller)
│   │   │   ├── recording/  # 録音関連API
│   │   │   ├── transcribe/ # 文字起こしAPI
│   │   │   └── analysis/   # 分析API
│   │   ├── core/           # DB接続, 設定
│   │   ├── models/         # SQLAlchemyモデル (Model)
│   │   ├── schemas/        # Pydanticスキーマ (DTO)
│   │   ├── services/       # ビジネスロジック (Service)
│   │   │   ├── transcribe_service.py
│   │   │   ├── analysis_service.py
│   │   │   └── storage_service.py
│   │   ├── utils/          # 共通ユーティリティ
│   │   └── main.py         # アプリエントリポイント
│   ├── Dockerfile
│   └── requirements.txt
│
├── infrastructure/          # IaC (Terraform)
│   ├── modules/
│   │   ├── ecs/           # ECSクラスター設定
│   │   ├── rds/           # データベース設定
│   │   ├── s3/            # ストレージ設定
│   │   └── vpc/           # ネットワーク設定
│   ├── environments/
│   │   ├── dev/           # 開発環境
│   │   ├── staging/       # ステージング環境
│   │   └── prod/          # 本番環境
│   └── main.tf
│
├── docker-compose.yml       # ローカル開発用
├── .env                     # 共通環境変数
├── .gitignore
└── README.md
```